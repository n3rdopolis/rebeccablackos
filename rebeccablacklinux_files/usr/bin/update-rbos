#! /bin/bash
#    Copyright (c) 2012, 2013, 2014 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackLinux.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#This script performs an update from anything on the SVN, it can be specified to rerun the build scripts, but by default it doesn't. For most users, this shouldn't be run for all SVN updates, as many commits add new build scripts, or launchers, and they would have to run those.

#Require root privlages
if [[ $UID != 0 ]]
then
  echo "Must be run as root."
  exit
fi

cd /usr/share

apt-get update
apt-get install aptitude git bzr subversion mercurial wget dselect -y --force-yes 
#download off the SVN
svn co https://rebeccablackos.svn.sourceforge.net/svnroot/rebeccablackos
#make the files owned by root, and executable
chmod +x -R /usr/share/rebeccablackos/
chown  root  /usr/share/rebeccablackos/
chgrp  root  -R /usr/share/rebeccablackos/
#copy the files where they belong
cp -a /usr/share/rebeccablackos/rebeccablacklinux_files/* /
rm -rf /usr/import/tmp
rm -rf /usr/import/usr/import

rsync /usr/import/* -a /

#Make all systemd units nonexecutable
find /etc/systemd/system /lib/systemd/system -type f | while read FILE
do
  chmod -X "$FILE"
done


#Ensure that the weston binary called by weston-launch is redirected to a symlink to the file in /usr/bin, so that it doesn't need to be updated in two places
rm /opt/bin/weston
ln -s /usr/bin/westonlaunchcaller /opt/bin/weston

chmod 777 /tmp

#Run the script that creates the new menu objects from /usr/share/RBOS_MENU
install_menu_items 


#If the user opted to build, install all packages specified by INSTALLS.txt, and run compile_all
if [[ $1 == build ]]
then 
  #LIST OF PACKAGES TO GET INSTALLED
  INSTALLS="$(cat /tmp/INSTALLS.txt | awk -F "#" '{print $1}')"
 
  #DOWNLOAD THE PACKAGES SPECIFIED
  echo "$INSTALLS" | while read PACKAGEINSTRUCTION
  do
    PACKAGE=$(echo $PACKAGEINSTRUCTION | awk -F "::" '{print $1}' )
    METHOD=$(echo $PACKAGEINSTRUCTION | awk -F "::" '{print $2}' )

    if [[ $METHOD == "PART" ]]
    then
      apt-get --no-install-recommends install $PACKAGE -y --force-yes
    elif [[ $METHOD == "FULL" ]]
    then
      apt-get install $PACKAGE -y --force-yes
    elif [[ $METHOD == "BUILDDEP" ]]
    then
      apt-get build-dep $PACKAGE -y --force-yes
    else
      echo "Invalid Install Operation"
    fi

  done

  #delete the downloaded file cache
  apt-get clean

  #set default cursor theme
  update-alternatives --set x-cursor-theme /etc/X11/cursors/oxy-white.theme
 
  compile_all build-only
else
  echo "not building source because this script wasn't called with the option 'build'"
fi

#Get the user that called the script, and update the users profile from /etc/skel
su $SUDO_USER -c update-rbos-user