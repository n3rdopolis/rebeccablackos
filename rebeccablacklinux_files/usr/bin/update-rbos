#! /bin/bash
#    Copyright (c) 2012, 2013, 2014 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackLinux.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#Require root privlages
if [[ $UID != 0 ]]
then
  echo "Must be run as root."
  exit
fi

cd /usr/share

apt-get update
yes Y |apt-get install subversion git bzr mercurial
#download off the SVN
svn co https://rebeccablackos.svn.sourceforge.net/svnroot/rebeccablackos
#make the files owned by root, and executable
chmod +x -R /usr/share/rebeccablackos/
chown  root  /usr/share/rebeccablackos/
chgrp  root  -R /usr/share/rebeccablackos/
#copy the files where they belong
cp -a /usr/share/rebeccablackos/rebeccablacklinux_files/* /
rm -rf /usr/import/tmp
rm -rf /usr/import/usr/import

rsync /usr/import/* -a /

chmod 777 /tmp

#Install menu items
install_menu_items 



if [[ $1 == build ]]
then 
  #Redirect these utilitues to /bin/true during the live CD Build process. They aren't needed and cause package installs to complain
  dpkg-divert --local --rename --add /usr/sbin/grub-probe
  dpkg-divert --local --rename --add /sbin/initctl
  ln -s /bin/true /sbin/initctl
  ln -s /bin/true /usr/sbin/grub-probe

  #LIST OF PACKAGES TO GET INSTALLED
  INSTALLS="$(cat /tmp/INSTALLS.txt | awk -F "#" '{print $1}')"
 
  #DOWNLOAD THE PACKAGES SPECIFIED
  echo "$INSTALLS" | while read PACKAGEINSTRUCTION
  do
    PACKAGE=$(echo $PACKAGEINSTRUCTION | awk -F "::" '{print $1}' )
    METHOD=$(echo $PACKAGEINSTRUCTION | awk -F "::" '{print $2}' )

    if [[ $METHOD == "PART" ]]
    then
      yes Yes | apt-get --no-install-recommends install $PACKAGE -y --force-yes
    elif [[ $METHOD == "FULL" ]]
    then
      yes Yes | apt-get install $PACKAGE -y --force-yes
    elif [[ $METHOD == "BUILDDEP" ]]
    then
      yes Y | apt-get build-dep $PACKAGE -y --force-yes
    else
      echo "Invalid Install Operation"
    fi

  done

  #Reset the utilites back to the way they are supposed to be.
  rm /sbin/initctl
  rm /usr/sbin/grub-probe
  dpkg-divert --local --rename --remove /usr/sbin/grub-probe
  dpkg-divert --local --rename --remove /sbin/initctl

  #delete the downloaded file cache
  apt-get clean

  #set default cursor theme
  update-alternatives --set x-cursor-theme /etc/X11/cursors/oxy-white.theme
 
  compile_all build-only
else
  echo "not building source because this script wasn't called with the option 'build'"
fi