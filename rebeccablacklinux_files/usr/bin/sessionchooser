#! /bin/bash
#    Copyright (c) 2012, nerdopolis (or n3rdopolis) <bluescreen_avenger@version.net>
#
#    This file is part of RebeccaBlackLinux.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

export SESSIONCALLERPID=$$

#start by allowing user to select weston by default
USEWESTON=1

while [[ $USEWESTON == 1 ]]
do
SERVER=$(kdialog --menu "- Choose weston to attempt to run the weston display server

- Choose Weston Fullscreen Under Xorg for running a fullscreen weston under an xserver 
for hardware that doen't have the approriate drivers for running weston as a display server

- Choose Weston Fullscreen Under Xorg Display Server With Software Rendering for a software
rendered weston server running fullscreen under an xserver. This is for systems with hardware 
or drivers that don't support hardware rendering.

- Chose KDE to start a KDE session

- Choose Logoff or hit cancel to logoff
--------------------------------------------------------------------------------------------
$WESTONRETURNSTRING Choose a Display Server." "Wayland" "Native Weston Display Server" "Xwayland" "Weston Fullscreen Under Xorg Display Server" "MinimalXwayland" "Weston Fullscreen Under Xorg Display Server With Software Rendering" "Xorg" "KDE Under Xorg Display Server" "NONE" "Logoff")


if [ $SERVER == "Wayland" ]
then

USEWESTON=1
/opt/bin/weston-launch
WESTONRETURNSTRING="Weston either crashed, or been exited, or current drivers for your 
hardware do not support the functionality needed for it to run as a display server. 
" 
kdialog --msgbox "$WESTONRETURNSTRING"

elif [ $SERVER == "Xwayland" ]
then
USEWESTON=1
kwin &
sleep 5
westoncaller --fullscreen
WESTONRETURNSTRING="Weston either crashed, or been exited." 
kdialog --msgbox "$WESTONRETURNSTRING"


elif [ $SERVER == "MinimalXwayland" ]
then
USEWESTON=1


DIMENSIONS=$(xwininfo -root | grep 'geometry' | awk '{print $2}' | awk -F + '{print $1}' )
WIDTH=$(echo $DIMENSIONS | awk -F x '{print $1}')
HEIGHT=$(echo $DIMENSIONS | awk -F x '{print $2}')

westoncaller --fullscreen --width=$WIDTH --height=$HEIGHT --use-pixman
WESTONRETURNSTRING="Weston either crashed, or been exited." 
kdialog --msgbox "$WESTONRETURNSTRING"


#If user selects to not use weston, escape the loop
else
USEWESTON=0
fi

done


if [ $SERVER == "Xorg" ]
then
startkde
fi

if [ $SERVER == "NONE" ]
then
exit
fi