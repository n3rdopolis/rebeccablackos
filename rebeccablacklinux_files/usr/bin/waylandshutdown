#! /bin/bash
#    Copyright (c) 2012, 2013, 2014 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackLinux.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#This script provides a shutdown prompt with Zenity within a wayland session. It reports to the user if the requested action failed. 

#The first line is sent to the zenity dialog is the actual command it sets the ACTION variable to be. the second line is what it appears as in the Zenity dialog for the user.
ACTION=$(echo "Switch User
Switch User
Logoff
Logoff Session
Shutdown
Shutdown Computer
Restart
Restart Computer
Shutdown
Shutdown Computer
Standby
Standby Computer
Hybrid Sleep
Hybrid Sleep
Hibernate
Hibernate Computer" | zenity --title="Leave..." --height=450 --list  --hide-header --text="What do you want to do?" --separator="\n" --column 'action' --column 'useraction' --print-column=1 --hide-column=1 2>/dev/null )
CancelOrOK=$?
ACTION=$(echo "$ACTION" | head -1 )
if [[ $CancelOrOK != 0 ]]
then
  exit 1
fi

zenity --title="Leave..." --question --text="Are you sure you want to $ACTION"
CONFIRM=$?
if [[ $CONFIRM == 0 ]]
then

  #For switch user, send the Switch command to the waylandloginmanager
  if [[ $ACTION == "Switch User" ]]
  then
    echo -e "\nSwitch" > /run/waylandloginmanager/loginmanager_control
    RESULT=$?
  #If the request is logoff, then unmount ecryptfs, tell the waylandloginmanager to switch to its TTY, and terminate the current server.
  elif [[ $ACTION == "Logoff" ]]
  then
    ecryptfs-umount-private
    echo -e "\nChange" > /run/waylandloginmanager/loginmanager_control
    disown
    fuser -k -15 $XDG_RUNTIME_DIR/$WAYLAND_DISPLAY
    RESULT=$?
  #For all other actions, use logind dbus commands
  elif [[ $ACTION == "Shutdown" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.PowerOff boolean:true
    RESULT=$?
  elif [[ $ACTION == "Restart" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Reboot boolean:true
    RESULT=$?
  elif [[ $ACTION == "Standby" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Suspend boolean:true
    RESULT=$?
  elif [[ $ACTION == "Hybrid Sleep" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.HybridSleep boolean:true
    RESULT=$?
  elif [[ $ACTION == "Hibernate" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Hibernate boolean:true
    RESULT=$?
  else
    exit
  fi

  #if the selected action failed, tell the user
  if [[ $RESULT != 0 ]]
  then
    zenity --title="Failure" --warning --text="Failed to $ACTION"
  fi
fi