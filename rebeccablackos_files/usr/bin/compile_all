#! /bin/bash
#    Copyright (c) 2012, 2013, 2014, 2015, 2016, 2017, 2018 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackOS.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#This script calls all files in /usr/bin/Compile in the needed order. it also fowards if it was called with build-only or download-only to the scripts.
#It also configures build_core (which is used by all of the build scripts) to create debs as they build, by turning on the BUILDCOREMAKEDEBS argument.

MAXDOWNLOADINSTANCES=5
MAXCLEANINSTANCES=5
argument=$1

CLEANUPOVERLAY=1
export BUILDCOREMAKEDEBS=1
if [[ $(mountpoint -q /tmp/srcbuild_overlay/; echo $?) == 0 && $CLEANUPOVERLAY == 1 ]]
then
  export BUILDCORECLEANOVERLAY=1
fi

function CompilePackage
{
  BUILDNAME=$1

  #compile_all is running to download the source
  if [[ "$argument" == download-only ]]
  then
    echo "Downloading/updating $BUILDNAME source"

    #Allow more than one downloads running at a time, only downloads and clean can run more than one at a time
    #Even smalldebinstall cannot, as only one instance of dpkg can run
    RUNJOBS=($(jobs -rp))
    RUNJOBSCOUNT=${#RUNJOBS[@]}
    while [[ $RUNJOBSCOUNT -ge $MAXDOWNLOADINSTANCES ]]
    do
      RUNJOBS=($(jobs -rp))
      RUNJOBSCOUNT=${#RUNJOBS[@]}
      sleep .1
    done
    if [[ -x /usr/bin/Compile/$BUILDNAME ]]
    then
      build_core buildspec "/usr/bin/Compile/$BUILDNAME" download-only 2>&1 &
    else
      mkdir -p /buildlogs/build_core/$BUILDNAME
      echo "Builder for $BUILDNAME does not exist in /usr/bin/Compile/" | tee /buildlogs/build_core/$BUILDNAME/ExecDownloadBuilder
      echo "$BUILDNAME" >> /buildlogs/build_core/faileddownloads
      return
    fi
  fi

  #compile_all is running to build the source
  if [[ "$argument" == build-only ]]
  then
    #Cleanup any files in the srcbuild_overlay from the last build
    echo "building $BUILDNAME"
    if [[ -x /usr/bin/Compile/$BUILDNAME ]]
    then
      build_core buildspec "/usr/bin/Compile/$BUILDNAME" build-only 2>&1
    else
      mkdir -p /buildlogs/build_core/$BUILDNAME
      echo "Builder for $BUILDNAME does not exist in /usr/bin/Compile/" | tee /buildlogs/build_core/$BUILDNAME/ExecCompileBuilder
      echo "$BUILDNAME" >> /buildlogs/build_core/failedcompiles
      return
    fi
    if [[ $BUILDCORECLEANOVERLAY == 1 ]]
    then
      mount -o remount /srcbuild/
    fi
  fi

  #Install the smaller version of the package
  if [[ "$argument" == installsmallpackage ]]
  then
    echo "Attempting to install smaller version of $BUILDNAME"
    if [[ -x /usr/bin/Compile/$BUILDNAME ]]
    then
      build_core buildspec "/usr/bin/Compile/$BUILDNAME" installsmallpackage 2>&1
    else
      mkdir -p /buildlogs/build_core/$BUILDNAME
      echo "Builder for $BUILDNAME does not exist in /usr/bin/Compile/" | tee /buildlogs/build_core/$BUILDNAME/ExecSmallInstallBuilder
      return
    fi
  fi
  
  #compile_all is running to clean the source
  if [[ "$argument" == clean ]]
  then
    echo "Cleaning $BUILDNAME"

    #Allow more than one cleans running at a time
    RUNJOBS=($(jobs -rp))
    RUNJOBSCOUNT=${#RUNJOBS[@]}
    while [[ $RUNJOBSCOUNT -ge $MAXCLEANINSTANCES ]]
    do
      RUNJOBS=($(jobs -rp))
      RUNJOBSCOUNT=${#RUNJOBS[@]}
      sleep .1
    done
    if [[ -x /usr/bin/Compile/$BUILDNAME ]]
    then
      build_core buildspec "/usr/bin/Compile/$BUILDNAME" clean 2>&1 &
    else
      mkdir -p /buildlogs/build_core/$BUILDNAME
      echo "Builder for $BUILDNAME does not exist in /usr/bin/Compile/" | tee /buildlogs/build_core/$BUILDNAME/ExecCleanBuilder
      return
    fi
  fi
  
  #compile_all is running to download and build
  if [[ ! -n "$argument" ]]
  then
    if [[ -x /usr/bin/Compile/$BUILDNAME ]]
    then
      build_core buildspec "/usr/bin/Compile/$BUILDNAME"
    else
      echo "Builder for $BUILDNAME does not exist in /usr/bin/Compile/"
      return
    fi
  fi
  
}

#build these packages in this order.
if [[ ! -e /usr/lib/casper ]]
then
  CompilePackage casper
fi

if [[ ! -e /usr/share/initramfs-tools/hooks/lupin_casper ]]
then
  CompilePackage lupin
fi

#CompilePackage linux
CompilePackage cmake
CompilePackage meson
#CompilePackage rust
#CompilePackage cargo
CompilePackage llvm
CompilePackage extra-cmake-modules
CompilePackage wayland
CompilePackage wayland-protocols
CompilePackage drm
CompilePackage macros
CompilePackage xorgproto
CompilePackage proto
CompilePackage libxcb
CompilePackage libxfont
CompilePackage vulkan
CompilePackage shaderc
CompilePackage mesa
CompilePackage glu
CompilePackage glamor
CompilePackage libepoxy
CompilePackage libxkbcommon
CompilePackage libevdev
CompilePackage pixman
CompilePackage pycairo
CompilePackage libva
CompilePackage intel-driver
CompilePackage libinput
CompilePackage freerdp
CompilePackage weston
CompilePackage glib
CompilePackage umockdev
CompilePackage gobject-introspection
CompilePackage libgudev
CompilePackage upower
CompilePackage atk
CompilePackage at-spi2-core
CompilePackage at-spi2-atk
CompilePackage gdk-pixbuf
CompilePackage graphene
CompilePackage icu-i18n
CompilePackage mir
CompilePackage gtk3
CompilePackage harfbuzz
CompilePackage freetype2
CompilePackage cairo
CompilePackage fontconfig
CompilePackage pango
CompilePackage gstreamer
CompilePackage gst-plugins-base
CompilePackage gst-plugins-bad
CompilePackage gst-plugins-good
CompilePackage gst-plugins-ugly
CompilePackage gst-plugins-gl
CompilePackage gst-libav
CompilePackage pipewire
CompilePackage qtbase
CompilePackage qtxmlpatterns
CompilePackage qtdeclarative
CompilePackage qtmultimedia
CompilePackage qtsvg
CompilePackage qtsensors
CompilePackage qtimageformats
CompilePackage qtsystems
CompilePackage qt3d
CompilePackage qtwebkit
CompilePackage qtwebsockets
CompilePackage qtwebchannel
CompilePackage qtwebengine
CompilePackage qtscript
CompilePackage qtquick1
CompilePackage qtquickcontrols
CompilePackage qtquickcontrols2
CompilePackage qttools
CompilePackage qtx11extras
CompilePackage qttranslations
CompilePackage qtgraphicaleffects
CompilePackage qtwayland
CompilePackage qbs
CompilePackage qca
CompilePackage otter
CompilePackage libdbusmenu-qt
CompilePackage phonon
CompilePackage phonon-gstreamer
CompilePackage polkit-qt-1
CompilePackage gcab
CompilePackage appstream
CompilePackage appstream-glib
CompilePackage NetworkManager
CompilePackage kdeframeworks/attica
CompilePackage kdeframeworks/kwayland
CompilePackage kdeframeworks/kitemmodels
CompilePackage kdeframeworks/kitemviews
CompilePackage kdeframeworks/kplotting
CompilePackage kdeframeworks/threadweaver
CompilePackage kdeframeworks/kcodecs
CompilePackage kdeframeworks/kguiaddons
CompilePackage kdeframeworks/kidletime
CompilePackage kdeframeworks/kwidgetsaddons
CompilePackage kdeframeworks/sonnet
CompilePackage kdeframeworks/kconfig
CompilePackage kdeframeworks/kwindowsystem
CompilePackage kdeframeworks/networkmanager-qt
CompilePackage kdeframeworks/modemmanager-qt
CompilePackage kdeframeworks/bluez-qt
CompilePackage kdeframeworks/solid
CompilePackage kdeframeworks/kirigami
CompilePackage kdeframeworks/prison
CompilePackage kdeframeworks/karchive
CompilePackage kdeframeworks/syntax-highlighting
CompilePackage kdeframeworks/kdbusaddons
CompilePackage kdeframeworks/kcoreaddons
CompilePackage kdeframeworks/kimageformats
CompilePackage kdeframeworks/kauth
CompilePackage kdeframeworks/kcrash
CompilePackage kdeframeworks/kjobwidgets
CompilePackage kdeframeworks/ki18n
CompilePackage kdeframeworks/kfilemetadata
CompilePackage kdeframeworks/kdoctools
CompilePackage kdeframeworks/kjs
CompilePackage kdeframeworks/syndication
CompilePackage kdeframeworks/kservice
CompilePackage kdeframeworks/kglobalaccel
CompilePackage kdeframeworks/kpackage
CompilePackage kdeframeworks/kpeople
CompilePackage kdeframeworks/kconfigwidgets
CompilePackage kdeframeworks/kiconthemes
CompilePackage kdeframeworks/knotifications
CompilePackage kdeframeworks/kcompletion
CompilePackage kdeframeworks/kdnssd
CompilePackage kdeframeworks/kwallet
CompilePackage kdeframeworks/kpty
CompilePackage kdeframeworks/kemoticons
CompilePackage kdeframeworks/kdesu
CompilePackage kdeframeworks/ktextwidgets
CompilePackage kdeframeworks/kxmlgui
CompilePackage kdeframeworks/kbookmarks
CompilePackage kdeframeworks/qqc2-desktop-style
CompilePackage kdeframeworks/kholidays
CompilePackage kdeframeworks/kio
CompilePackage kdeframeworks/baloo
CompilePackage kdeframeworks/kxmlrpcclient
CompilePackage kdeframeworks/knewstuff
CompilePackage kdeframeworks/kparts
CompilePackage kdeframeworks/kdeclarative
CompilePackage kdeframeworks/kcmutils
CompilePackage kdeframeworks/kactivities
CompilePackage kdeframeworks/kactivities-stats
CompilePackage kdeframeworks/kinit
CompilePackage kdeframeworks/kded
CompilePackage kdeframeworks/knotifyconfig
CompilePackage kdeframeworks/kunitconversion
CompilePackage kdeframeworks/kjsembed
CompilePackage kdeframeworks/kross
CompilePackage kdeframeworks/kmediaplayer
CompilePackage kdeframeworks/kdewebkit
CompilePackage kdeframeworks/kdesignerplugin
CompilePackage kdeframeworks/ktexteditor
CompilePackage kdeframeworks/kapidox
CompilePackage kdeframeworks/purpose
CompilePackage kdeframeworks/frameworkintegration
CompilePackage kdeframeworks/plasma-framework
CompilePackage kdeframeworks/krunner
CompilePackage kdeframeworks/kdelibs4support
CompilePackage kdeframeworks/khtml
CompilePackage kdeframeworks/oxygen-icons5
CompilePackage kwayland-integration
CompilePackage kwallet-pam
CompilePackage kwalletmanager
CompilePackage libkomparediff2
CompilePackage grantlee
CompilePackage baloo-widgets
CompilePackage kpmcore
CompilePackage milou
CompilePackage khelpcenter
CompilePackage kio-extras
CompilePackage konqueror
CompilePackage kfind
CompilePackage kdialog
CompilePackage keditbookmarks
CompilePackage dolphin
CompilePackage libksysguard
CompilePackage ksysguard
CompilePackage kdecoration
CompilePackage kscreenlocker
CompilePackage oxygen
CompilePackage breeze
CompilePackage kvantum
CompilePackage plasma-integration
CompilePackage xdg-desktop-portal-kde
CompilePackage kwin
CompilePackage libkscreen
CompilePackage plasma-workspace
CompilePackage plasma-desktop
CompilePackage kde-cli-tools
CompilePackage latte-dock
CompilePackage kactivitymanagerd
CompilePackage khotkeys
CompilePackage kinfocenter
CompilePackage kmenuedit
CompilePackage systemsettings
CompilePackage kwrited
CompilePackage kscreen
CompilePackage powerdevil
CompilePackage polkit-kde-agent-1
CompilePackage falkon
CompilePackage libkdegames
CompilePackage kpat
CompilePackage kmix
CompilePackage konsole
CompilePackage kate
CompilePackage amarok
CompilePackage ark
CompilePackage konversation
CompilePackage kcalc
CompilePackage kolourpaint
CompilePackage spectacle
CompilePackage kompare
CompilePackage dragon
CompilePackage elisa
CompilePackage kdeplasma-addons
CompilePackage plasma-nm
CompilePackage calligra
CompilePackage qbs-shared
CompilePackage wind
CompilePackage qtaccountsservice
CompilePackage libqtxdg
CompilePackage qtgsettings
CompilePackage libliri
CompilePackage qtudev
CompilePackage lirios-wayland
CompilePackage lirios-qml-xwayland
CompilePackage materialdecoration
CompilePackage fluid
CompilePackage vibe
CompilePackage lirios-pulseaudio
CompilePackage lirios-networkmanager
CompilePackage lirios-shell
CompilePackage lirios-screenshot
CompilePackage lirios-platformtheme
CompilePackage lirios-power-manager
CompilePackage lirios-settings
CompilePackage xserver
CompilePackage xhost
CompilePackage libmozjs
CompilePackage json-c
CompilePackage json-glib
CompilePackage librsvg
CompilePackage yelp-xsl
CompilePackage yelp-tools
CompilePackage zenity
CompilePackage gnome-themes-standard
CompilePackage dconf
CompilePackage gconf
CompilePackage unico
CompilePackage vte
CompilePackage cogl
CompilePackage clutter
CompilePackage clutter-gtk
CompilePackage clutter-gst
CompilePackage gjs
CompilePackage libusb
CompilePackage gsettings-desktop-schemas
CompilePackage glib-networking
CompilePackage libsoup
CompilePackage librest
CompilePackage libnotify
CompilePackage gcr
CompilePackage geoclue
CompilePackage libsecret
CompilePackage webkitgtk
CompilePackage totem-pl-parser
CompilePackage gnome-online-accounts
CompilePackage geocode-glib
CompilePackage libgweather
CompilePackage libgdata
CompilePackage evolution-data-server
CompilePackage libpeas
CompilePackage gtksourceview
CompilePackage libgtop
CompilePackage gnome-desktop
CompilePackage libcanberra
CompilePackage cheese
CompilePackage notification-daemon
CompilePackage gnome-bluetooth
CompilePackage gnome-menus
CompilePackage libgnome-keyring
CompilePackage mobile-broadband-provider-info
CompilePackage network-manager-applet
CompilePackage mutter
CompilePackage ibus
CompilePackage colord-gtk
CompilePackage gnome-shell
CompilePackage gnome-shell-extensions
CompilePackage gnome-settings-daemon
CompilePackage gnome-autoar
CompilePackage pygobject
CompilePackage libgee
CompilePackage caribou
CompilePackage gnome-session
CompilePackage gdm
CompilePackage alacarte
CompilePackage nautilus
CompilePackage gspell
CompilePackage gedit
CompilePackage file-roller
CompilePackage gnome-font-viewer
CompilePackage grilo
CompilePackage grilo-plugins
CompilePackage gnome-control-center
CompilePackage cairo-dock-core
CompilePackage cairo-dock-plugins
CompilePackage gtk4
CompilePackage plasma-pa #Needs gconf
#CompilePackage orbital
CompilePackage efl
CompilePackage enlightenment
CompilePackage terminology
CompilePackage etrophy
CompilePackage e_cho
CompilePackage elemines
CompilePackage econcentration
CompilePackage equate
CompilePackage ecrire
CompilePackage ephoto
CompilePackage SDL
CompilePackage SDL_image
CompilePackage SDL_ttf
CompilePackage glbinding
CompilePackage supertux
CompilePackage FreeGLUT
CompilePackage glfw
CompilePackage ffmpeg
CompilePackage mpv
CompilePackage glmark
CompilePackage bemenu
CompilePackage wlc
CompilePackage wlroots
#CompilePackage orbment
CompilePackage sway

if [[ ! -e /usr/bin/ubiquity ]]
then
  CompilePackage calamares
fi

wait
