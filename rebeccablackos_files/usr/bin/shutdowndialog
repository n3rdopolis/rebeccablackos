#! /bin/bash
#    Copyright (c) 2012, 2013, 2014, 2015, 2016, 2017 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackOS.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#This script provides a shutdown prompt with Zenity within a wayland session. It reports to the user if the requested action failed. 

#The first line is sent to the zenity dialog is the actual command it sets the ACTION variable to be. the second line is what it appears as in the Zenity dialog for the user.

# TODO find if this is needed
ONLY_SEAT0_SESSION_SWITCH=1

SeatCanMultiSession=$(loginctl show-seat $XDG_SEAT -p CanMultiSession --value)

if [[ $ONLY_SEAT0_SESSION_SWITCH == 0 || $SeatCanMultiSession == "yes" ]]
then
  ACTIONSTRING="Switch User"$'\n'"Switch User"
fi

if [[ ! -z $ACTIONSTRING ]]
then
  ACTIONSTRING+=$'\n'
fi
ACTIONSTRING+="Logoff"$'\n'"Logoff Session"


CanPowerOff=$(dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.CanPowerOff |grep -c yes)
if [[ $CanPowerOff == 1 ]]
then
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Shutdown"
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Shutdown Computer"
fi
CanReboot=$(dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.CanReboot |grep -c yes)
if [[ $CanReboot == 1 ]]
then
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Restart"
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Restart Computer"
fi
CanSuspend=$(dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.CanSuspend |grep -c yes)
if [[ $CanSuspend == 1 ]]
then
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Standby"
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Standby Computer"
fi
CanHybridSleep=$(dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.CanHybridSleep |grep -c yes)
if [[ $CanHybridSleep == 1 ]]
then
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Hybrid Sleep"
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Hybrid Sleep Computer"
fi
CanHibernate=$(dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.CanHibernate |grep -c yes)
if [[ $CanHibernate == 1 ]]
then
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Hibernate"
  ACTIONSTRING+=$'\n'
  ACTIONSTRING+="Hibernate Computer"
fi

ACTION=$(echo "$ACTIONSTRING" | zenity --title="Leave..." --height=450 --list  --hide-header --text="What do you want to do?" --separator="\n" --column 'action' --column 'useraction' --print-column=1 --hide-column=1 2>/dev/null )
CancelOrOK=$?
if [[ $CancelOrOK != 0 ]]
then
  exit 1
fi

#Prompt the user if they are sure they want to execute the selected action
zenity --width=450 --title="Leave..." --question --text="Are you sure you want to $ACTION"
CONFIRM=$?
if [[ $CONFIRM == 0 ]]
then

  #For switch user, send the Switch command to the waylandloginmanager
  if [[ $ACTION == "Switch User" ]]
  then
    waylandloginmanager --sendcommand Switch
    RESULT=$?
  #If the request is logoff, then unmount ecryptfs, tell the waylandloginmanager to switch to its TTY, and terminate the current server.
  elif [[ $ACTION == "Logoff" ]]
  then
    ecryptfs-umount-private
    waylandloginmanager --sendcommand Change
    loginctl terminate-session $XDG_SESSION_ID
    sleep 3
    disown
    nohup fuser -k -15 "/dev/tty$(loginctl show-session $XDG_SESSION_ID| grep VTNr| awk -F = '{print $2}')" >/dev/null 2>&1 &
    RESULT=$?
  #For all other actions, use logind dbus commands
  elif [[ $ACTION == "Shutdown" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.PowerOff boolean:true
    RESULT=$?
  elif [[ $ACTION == "Restart" ]]
  then
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Reboot boolean:true
    RESULT=$?
  elif [[ $ACTION == "Standby" ]]
  then
    loginctl lock-session
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Suspend boolean:true
    RESULT=$?
  elif [[ $ACTION == "Hybrid Sleep" ]]
  then
    loginctl lock-session
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.HybridSleep boolean:true
    RESULT=$?
  elif [[ $ACTION == "Hibernate" ]]
  then
    loginctl lock-session
    dbus-send --print-reply --system --dest=org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager.Hibernate boolean:true
    RESULT=$?
  else
    exit
  fi

  #if the selected action failed, tell the user
  if [[ $RESULT != 0 ]]
  then
    zenity --title="Failure" --warning --text="Failed to $ACTION"
  fi
fi
