#! /bin/bash
#    Copyright (c) 2012 - 2022 nerdopolis (or n3rdopolis) <bluescreen_avenger@verzion.net>
#
#    This file is part of RebeccaBlackOS.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

#Inherit functions and variables from the script in /usr/bin/build_core
. /usr/bin/build_core

#The name of the source code folder that gets created
SOURCENAME=linux-kernel

#The URL of the Source code repo
SOURCEURL=https://gitlab.com/linux-kernel/stable.git

#The Type of repository the source code is on. Either 'GIT', 'SVN', 'BZR', 'HG', or 'ARCHIVE'.
REPOSITORYTYPE=GIT

#The revision of the source repo to use. To get the lastest revision for GIT it's 'git:defaultbranch', for SVN it's 'HEAD', for BZR, it's 'last:1', and for HG it's 'default', without the quotes. ARCHIVE doesn't have revisions
SOURCEREVISION=linux-5.14.y

#The prefix to compile and install the source code to
INSTALLDIR=/opt

#This variable is not manditory, /usr/bin/build_core sets it by default as 0, so that when it's set to create deb files, it only needs to build them once. 
REBUILDNEWREVISION=0

#Specify any custom revisions for git submodules in the format shown below
# SUBMODULEREVISIONS=(examplesubmodule master 
# nested/submodule 1.0
# 'submodule with spaces' master
# commitsubmodule 0123456789abcdef )
#
#This is an array where the first element specifies a submodule name, and the second element specifies the revision, the third specifies the name of another submodule, the fourth element specifies its revision and so on.
#If there are spaces in the submodule your are specifing, you will need to enclose the name in single quotes
#This is only applicable to git repositories with submodules

#VARIABLES PRESENTED
# EXTERNALBUILDHOME : For out of tree builds 
# INTERNALBUILDHOME : For in tree builds

#This gets called by DownloadSource in /usr/bin/build_core. If there are no other commands here, the colon (:) is MANDITORY as a NULL command, otherwise Bash complains of an empty function. These functions are custom commands that need to be done to download source.
function PackageDownloadSource
{
:
}


#This is called by PrepareBuild in /usr/bin/build_core. If there are no other commands here, the colon (:) is MANDITORY as a NULL command, otherwise Bash complains of an empty function. These functions are custom commands that need to be done to prepare the system to build the source
function PackagePrepareBuild()
{
cp /usr/share/RBOS_PATCHES/linux-kernel/config .config

#Enable SimpleDRM, SimpleDRM dependancies, and other useful drivers
sed -i '/CONFIG_X86_SYSFB[ =]/c\CONFIG_X86_SYSFB=y' .config
sed -i '/CONFIG_DRM_SIMPLEDRM[ =]/c\CONFIG_DRM_SIMPLEDRM=m' .config
sed -i '/CONFIG_DRM_GUD[ =]/c\CONFIG_DRM_GUD=m' .config

#Disable fbdev drivers
sed -i '/CONFIG_FB_CIRRUS[ =]/c\# CONFIG_FB_CIRRUS is not set' .config
sed -i '/CONFIG_FB_PM2[ =]/c\# CONFIG_FB_PM2 is not set' .config
sed -i '/CONFIG_FB_PM2_FIFO_DISCONNECT[ =]/c\# CONFIG_FB_PM2_FIFO_DISCONNECT is not set' .config
sed -i '/CONFIG_FB_CYBER2000[ =]/c\# CONFIG_FB_CYBER2000 is not set' .config
sed -i '/CONFIG_FB_CYBER2000_DDC[ =]/c\# CONFIG_FB_CYBER2000_DDC is not set' .config
sed -i '/CONFIG_FB_ARC[ =]/c\# CONFIG_FB_ARC is not set' .config
sed -i '/CONFIG_FB_VGA16[ =]/c\# CONFIG_FB_VGA16 is not set' .config
sed -i '/CONFIG_FB_UVESA[ =]/c\# CONFIG_FB_UVESA is not set' .config
sed -i '/CONFIG_FB_VESA[ =]/c\# CONFIG_FB_VESA is not set' .config
sed -i '/CONFIG_FB_EFI[ =]/c\# CONFIG_FB_EFI is not set' .config
sed -i '/CONFIG_FB_N411[ =]/c\# CONFIG_FB_N411 is not set' .config
sed -i '/CONFIG_FB_HGA[ =]/c\# CONFIG_FB_HGA is not set' .config
sed -i '/CONFIG_FB_LE80578[ =]/c\# CONFIG_FB_LE80578 is not set' .config
sed -i '/CONFIG_FB_CARILLO_RANCH[ =]/c\# CONFIG_FB_CARILLO_RANCH is not set' .config
sed -i '/CONFIG_FB_MATROX[ =]/c\# CONFIG_FB_MATROX is not set' .config
sed -i '/CONFIG_FB_MATROX_MILLENIUM[ =]/c\# CONFIG_FB_MATROX_MILLENIUM is not set' .config
sed -i '/CONFIG_FB_MATROX_MYSTIQUE[ =]/c\# CONFIG_FB_MATROX_MYSTIQUE is not set' .config
sed -i '/CONFIG_FB_MATROX_G[ =]/c\# CONFIG_FB_MATROX_G is not set' .config
sed -i '/CONFIG_FB_MATROX_I2C[ =]/c\# CONFIG_FB_MATROX_I2C is not set' .config
sed -i '/CONFIG_FB_MATROX_MAVEN[ =]/c\# CONFIG_FB_MATROX_MAVEN is not set' .config
sed -i '/CONFIG_FB_RADEON[ =]/c\# CONFIG_FB_RADEON is not set' .config
sed -i '/CONFIG_FB_RADEON_I2C[ =]/c\# CONFIG_FB_RADEON_I2C is not set' .config
sed -i '/CONFIG_FB_RADEON_BACKLIGHT[ =]/c\# CONFIG_FB_RADEON_BACKLIGHT is not set' .config
sed -i '/CONFIG_FB_ATY128[ =]/c\# CONFIG_FB_ATY128 is not set' .config
sed -i '/CONFIG_FB_ATY128_BACKLIGHT[ =]/c\# CONFIG_FB_ATY128_BACKLIGHT is not set' .config
sed -i '/CONFIG_FB_ATY[ =]/c\# CONFIG_FB_ATY is not set' .config
sed -i '/CONFIG_FB_ATY_CT[ =]/c\# CONFIG_FB_ATY_CT is not set' .config
sed -i '/CONFIG_FB_ATY_GX[ =]/c\# CONFIG_FB_ATY_GX is not set' .config
sed -i '/CONFIG_FB_ATY_BACKLIGHT[ =]/c\# CONFIG_FB_ATY_BACKLIGHT is not set' .config
sed -i '/CONFIG_FB_S3[ =]/c\# CONFIG_FB_S3 is not set' .config
sed -i '/CONFIG_FB_S3_DDC[ =]/c\# CONFIG_FB_S3_DDC is not set' .config
sed -i '/CONFIG_FB_SAVAGE[ =]/c\# CONFIG_FB_SAVAGE is not set' .config
sed -i '/CONFIG_FB_SIS[ =]/c\# CONFIG_FB_SIS is not set' .config
sed -i '/CONFIG_FB_SIS_300[ =]/c\# CONFIG_FB_SIS_300 is not set' .config
sed -i '/CONFIG_FB_SIS_315[ =]/c\# CONFIG_FB_SIS_315 is not set' .config
sed -i '/CONFIG_FB_VIA[ =]/c\# CONFIG_FB_VIA is not set' .config
sed -i '/CONFIG_FB_VIA_X_COMPATIBILITY[ =]/c\# CONFIG_FB_VIA_X_COMPATIBILITY is not set' .config
sed -i '/CONFIG_FB_NEOMAGIC[ =]/c\# CONFIG_FB_NEOMAGIC is not set' .config
sed -i '/CONFIG_FB_KYRO[ =]/c\# CONFIG_FB_KYRO is not set' .config
sed -i '/CONFIG_FB_3DFX[ =]/c\# CONFIG_FB_3DFX is not set' .config
sed -i '/CONFIG_FB_3DFX_I2C[ =]/c\# CONFIG_FB_3DFX_I2C is not set' .config
sed -i '/CONFIG_FB_VOODOO1[ =]/c\# CONFIG_FB_VOODOO1 is not set' .config
sed -i '/CONFIG_FB_VT8623[ =]/c\# CONFIG_FB_VT8623 is not set' .config
sed -i '/CONFIG_FB_TRIDENT[ =]/c\# CONFIG_FB_TRIDENT is not set' .config
sed -i '/CONFIG_FB_ARK[ =]/c\# CONFIG_FB_ARK is not set' .config
sed -i '/CONFIG_FB_PM3[ =]/c\# CONFIG_FB_PM3 is not set' .config
sed -i '/CONFIG_FB_SMSCUFX[ =]/c\# CONFIG_FB_SMSCUFX is not set' .config
sed -i '/CONFIG_FB_UDL[ =]/c\# CONFIG_FB_UDL is not set' .config
sed -i '/CONFIG_FB_VIRTUAL[ =]/c\# CONFIG_FB_VIRTUAL is not set' .config
sed -i '/CONFIG_XEN_FBDEV_FRONTEND[ =]/c\# CONFIG_XEN_FBDEV_FRONTEND is not set' .config
sed -i '/CONFIG_FB_MB862XX[ =]/c\# CONFIG_FB_MB862XX is not set' .config
sed -i '/CONFIG_FB_MB862XX_PCI_GDC[ =]/c\# CONFIG_FB_MB862XX_PCI_GDC is not set' .config
sed -i '/CONFIG_FB_MB862XX_I2C[ =]/c\# CONFIG_FB_MB862XX_I2C is not set' .config
sed -i '/CONFIG_FB_HYPERV[ =]/c\# CONFIG_FB_HYPERV is not set' .config


if [[ $DEB_HOST_MULTIARCH == i386-linux-gnu ]]
then
  sed -i '/CONFIG_64BIT[ =]/c\# CONFIG_64BIT is not set' .config
  sed -i '/CONFIG_X86_32[ =]/c\CONFIG_X86_32=y' .config
  sed -i '/CONFIG_X86_64[ =]/c\# CONFIG_X86_64 is not set' .config
  sed -i '/CONFIG_OUTPUT_FORMAT[ =]/c\CONFIG_OUTPUT_FORMAT="elf32-i386"' .config
  sed -i '/CONFIG_ARCH_DEFCONFIG[ =]/c\CONFIG_ARCH_DEFCONFIG="arch/x86/configs/i386_defconfig"' .config
  sed -i '/CONFIG_X86_PAE[ =]/c\CONFIG_X86_PAE=y"' .config
elif [[ $DEB_HOST_MULTIARCH == x86_64-linux-gnu ]]
then
  sed -i '/CONFIG_64BIT[ =]/c\CONFIG_64BIT=y' .config
  sed -i '/CONFIG_X86_32[ =]/c\# CONFIG_X86_32 is not set' .config
  sed -i '/CONFIG_X86_64[ =]/c\CONFIG_X86_64=y' .config
  sed -i '/CONFIG_OUTPUT_FORMAT[ =]/c\CONFIG_OUTPUT_FORMAT="elf64-x86-64"' .config
  sed -i '/CONFIG_ARCH_DEFCONFIG[ =]/c\CONFIG_ARCH_DEFCONFIG="arch/x86/configs/x86_64_defconfig"' .config
  sed -i '/CONFIG_X86_PAE[ =]/c\# CONFIG_X86_PAE is not set"' .config
else
  echo "$BUILDARCH not supported"
  rm .config
fi
make olddefconfig

BUILD_CONFIGVT_N=0
if [[ $BUILD_CONFIGVT_N == 1 ]]
then
  sed -i 's/CONFIG_VT=y/# CONFIG_VT is not set'/g .config
  sed -i 's/CONFIG_CONSOLE_TRANSLATIONS=y/# CONFIG_CONSOLE_TRANSLATIONS is not set'/g .config
  sed -i 's/CONFIG_VT_CONSOLE=y/# CONFIG_VT_CONSOLE is not set'/g .config
  sed -i 's/CONFIG_VT_CONSOLE_SLEEP=y/# CONFIG_VT_CONSOLE_SLEEP is not set'/g .config
  sed -i 's/CONFIG_HW_CONSOLE=y/# CONFIG_HW_CONSOLE is not set'/g .config
  sed -i 's/CONFIG_VT_HW_CONSOLE_BINDING=y/# CONFIG_VT_HW_CONSOLE_BINDING is not set'/g .config
fi

KernelVersion=$(cat .config|grep "Kernel Configuration" | awk '{print $3}')
echo "update-grub; update-initramfs -k all -c; linux-update-symlinks install $KernelVersion /boot/vmlinuz-$KernelVersion" > postinstall-pak
touch .scmversion
}

#This is called by MakeAndInstall in /usr/bin/build_core, when the PWD is in the source tree. The commands should build the source 
function PackageCompileSource()
{
make -j$BUILD_CPU_COUNT
}

#This is called by MakeAndInstall in /usr/bin/build_core. This is the routine to install the source. The PWD does not get inherited from PackageCompileSource, so if needed, the PWD needs to be changed here too.
function PackageInstallSource()
{
KernelVersion=$(cat .config|grep "Kernel Configuration" | awk '{print $3}')
make install
make modules_install
rm /boot/initrd*${KernelVersion}*
}

#This is called by MakeAndInstall in /usr/bin/build_core. If there are no other commands here, the colon (:) is MANDITORY as a NULL command, otherwise Bash complains of an empty function. These commands are custom install commands that are needed for this package that are not performed by the source install operation. 
function PackagePostInstall()
{
:
}

#Run the Build and or Download, based on the argument this script was called by. This is decided within /usr/bin/build_core
RunDownloadAndOrBuild
